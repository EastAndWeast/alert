# 需求分析：Scalping (刷单/剥头皮) 提醒系统

该系统用于监控交易持仓时间，当交易时长符合特定条件（如过短或过长）并满足附加过滤器条件时，触发警报。

## 1. 具体方案

### 技术实现路径
监控 MT4 的 `History Trades` 或 MT5 的 `Deals` 记录。由于持仓时间只能在平仓动作发生后计算，因此系统主要监听 **平仓事件**。

- **MT4**: 监听 `History` 中的订单，计算 `CloseTime - OpenTime`。
- **MT5**: 监听 `DEAL_ENTRY_OUT` 或 `DEAL_ENTRY_INOUT` 类型的成交，找到对应的入场成交（In），计算时间差。

### 核心判定逻辑
1.  **持仓时间计算**: `Duration = CloseTime - OpenTime`（单位：秒）。
2.  **基本条件判定**: 
    *   根据用户设置的逻辑（通常为 `Duration < Threshold`），判定是否满足时间条件。
3.  **多重过滤器 (Advanced Filters)**: 
    只有在基础时间条件满足的前提下，进一步检查以下过滤器（由用户配置开启或关闭）：
    *   **品种过滤**: 检查 `Symbol` 是否在监控范围内。
    *   **交易量过滤**: 检查 `Lots` 是否达到设定值。
    *   **USD价值过滤**:
        *   MT5: 判断该交易对应的 `DealInUSD`。
        *   MT4: 判断该交易折算后的 `OpenTradeInUSD`。
    *   **盈亏过滤**: 检查 `ProfitInUSD`（即该笔交易的最终获利金额，支持设置绝对值或范围）。

---

## 2. 例子

**场景：黄金（XAUUSD）极短线高获利交易监控**
- **风控配置**:
    - **基础条件**: 持仓时间 < `120秒`。
    - **过滤器**: 
        - 品种: `XAUUSD`
        - 手数: > `2.0`
        - 获利金额: > `$500`
- **动作过程**:
    *   16:00:00: 客户买入 5 手黄金（Value: $1,000,000）。
    *   16:01:30: 客户平仓，获利 `$1,200`。
- **系统判定**:
    *   `Duration = 90秒` (满足 < 120秒)。
    *   `Lots = 5` (满足 > 2.0)。
    *   `ProfitInUSD = $1200` (满足 > $500)。
    *   **结果**: **触发报警**。
    *   **警报内容**: `[Scalping预警] 账户: 777777 | 品种: XAUUSD | 持仓时间: 90s | 手数: 5.0 | 盈亏: +$1200 | 满足所有设置条件`

---

## 3. 配置参数

建议在控制面板中为 Scalping 类型增加一个“灵活过滤器”组：

| 参数名称 | 类型 | 说明 | 示例值 |
| :--- | :--- | :--- | :--- |
| `Duration_Threshold` | Integer | 触发报警的时间阈值（秒） | `180` |
| `Comparison_Logic` | Enum | 时间对比逻辑 | `LESS_THAN` (持仓短于指标报警) |
| `Symbol_Filter` | Array | 监控的品种范围 | `["XAUUSD", "BTCUSD"]` |
| `Lot_Min` | Float | 参与判定的最小手数 | `0.1` |
| `USD_Value_Min` | Float | 参与判定的最小开仓USD价值 | `10000.0` |
| `Profit_USD_Min` | Float | 触发报警的最小获利金额 (USD) | `200.0` |
| `Include_Loss` | Boolean | 是否也监控亏损的短线交易 | `false` |
